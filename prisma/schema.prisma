datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Organization {
  id               String   @id @default(uuid())
  name             String
  contactEmail     String
  billingPlan      String
  billingRulesJson Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  users        User[]
  clients      Client[]
  activities   Activity[]
  invoices     Invoice[]
  payments     Payment[]
  reports      Report[]
  auditLogs    AuditLog[]
  serviceTypes ServiceType[]

  // NEW: Enhanced client profile entities
  clientContacts    ClientContact[]
  clientProviders   ClientProvider[]
  clientMedications ClientMedication[]
  clientAllergies   ClientAllergy[]
  clientInsurances  ClientInsurance[]
  clientRisks       ClientRisk[]
  clientDocuments   ClientDocument[]

  carePlans     CarePlan[]
  progressNotes ProgressNote[]

}

model User {
  id        String       @id @default(uuid())
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id])
  role      String // "admin" | "care_manager"
  name      String
  email     String       @unique
  password  String
  lastLogin DateTime?

  profileImageUrl String?
  title           String?
  phone           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  activities        Activity[]
  updatedActivities Activity[] @relation("ActivityUpdatedBy")

  auditLogs   AuditLog[]
  clients     Client[]     @relation("PrimaryCM")
  clientNotes ClientNote[] @relation("UserToClientNotes")

  createdCarePlans CarePlan[]      @relation("CarePlanCreatedBy")
  progressNotes    ProgressNote[]  @relation("UserToProgressNotes")

}

model Client {
  id    String       @id @default(uuid())
  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  primaryCMId String?
  primaryCM   User?   @relation("PrimaryCM", fields: [primaryCMId], references: [id])

  name                String
  dob                 DateTime
  address             String
  billingContactName  String
  billingContactEmail String
  billingContactPhone String
  billingRulesJson    Json
  status              String

  preferredName          String?
  primaryDiagnosis       String?
  livingSituation        String?
  riskFlags              Json?
  primaryLanguage        String?
  insurance              String?
  physicianName          String?
  physicianPhone         String?
  environmentSafetyNotes String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  activities Activity[]
  invoices   Invoice[]
  notes      ClientNote[]

  // NEW: Enhanced profile relations
  contacts    ClientContact[]
  providers   ClientProvider[]
  medications ClientMedication[]
  allergies   ClientAllergy[]
  insurances  ClientInsurance[]
  risks       ClientRisk[]
  documents   ClientDocument[]

  carePlans     CarePlan[]
  progressNotes ProgressNote[]

}

model Activity {
  id       String @id @default(uuid())
  orgId    String
  clientId String
  cmId     String

  org    Organization @relation(fields: [orgId], references: [id])
  client Client       @relation(fields: [clientId], references: [id])
  cm     User         @relation(fields: [cmId], references: [id])

  source       String // phone | email | visit | calendar | manual
  startTime    DateTime
  endTime      DateTime
  duration     Int
  billingCode  String?
  isBillable   Boolean
  aiConfidence Float
  notes        String
  isFlagged    Boolean
  capturedByAi Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  serviceTypeId String?
  serviceType   ServiceType? @relation(fields: [serviceTypeId], references: [id])

  updatedById   String?
  updatedByName String?

  updatedBy     User? @relation("ActivityUpdatedBy", fields: [updatedById], references: [id])

  invoiceItems InvoiceItem[]
}

model Invoice {
  id       String @id @default(uuid())
  orgId    String
  clientId String

  org    Organization @relation(fields: [orgId], references: [id])
  client Client       @relation(fields: [clientId], references: [id])

  periodStart DateTime
  periodEnd   DateTime
  status      String // draft | sent | paid | overdue
  totalAmount Float
  currency    String
  pdfUrl      String?
  sentAt      DateTime?
  paidAt      DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  items    InvoiceItem[]
  payments Payment[]
}

model InvoiceItem {
  id         String  @id @default(uuid())
  invoiceId  String
  activityId String?

  invoice  Invoice   @relation(fields: [invoiceId], references: [id])
  activity Activity? @relation(fields: [activityId], references: [id])

  description String
  quantity    Float
  unitPrice   Float
  amount      Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Note {
  id        String   @id @default(uuid())
  orgId     String
  clientId  String
  authorId  String
  content   String
  createdAt DateTime @default(now())
}

model Payment {
  id    String       @id @default(uuid())
  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  amount    Float
  method    String // "cash", "check", "bank", "card", "insurance", etc.
  status    String   @default("completed") // future: pending, failed
  paidAt    DateTime @default(now())
  reference String?

  createdAt DateTime @default(now())
}

model Report {
  id          String       @id @default(uuid())
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id])
  type        String
  periodStart DateTime
  periodEnd   DateTime
  fileUrl     String
  createdAt   DateTime     @default(now())
}

model AuditLog {
  id     String  @id @default(uuid())
  orgId  String
  userId String?

  org  Organization @relation(fields: [orgId], references: [id])
  user User?        @relation(fields: [userId], references: [id])
}

model ServiceType {
  id    String       @id @default(uuid())
  orgId String
  org   Organization @relation(fields: [orgId], references: [id])

  name        String
  billingCode String?
  rateType    String // "hourly" | "flat"
  rateAmount  Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  activities Activity[]
}

model ClientNote {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  authorId String
  author   User   @relation("UserToClientNotes", fields: [authorId], references: [id])

  content   String
  createdAt DateTime @default(now())
}

// =============================
// NEW MODELS FOR MINI-PHASE 2A
// =============================

model ClientContact {
  id       String       @id @default(uuid())
  orgId    String
  org      Organization @relation(fields: [orgId], references: [id])

  clientId String
  client   Client       @relation(fields: [clientId], references: [id])

  name         String
  relationship String?
  phone        String?
  email        String?
  address      String?
  notes        String?

  isEmergencyContact Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([clientId])
}

model ClientProvider {
  id       String       @id @default(uuid())
  orgId    String
  org      Organization @relation(fields: [orgId], references: [id])

  clientId String
  client   Client       @relation(fields: [clientId], references: [id])

  type      String      // "physician", "attorney", "facility", "therapist", etc.
  name      String
  specialty String?
  phone     String?
  email     String?
  address   String?
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([clientId])
  @@index([type])
}

model ClientMedication {
  id       String       @id @default(uuid())
  orgId    String
  org      Organization @relation(fields: [orgId], references: [id])

  clientId String
  client   Client       @relation(fields: [clientId], references: [id])

  name                String
  dosage              String?   // "10 mg", "1 tab"
  frequency           String?   // "BID", "once daily"
  route               String?   // "PO", "IV", "topical"
  prescribingProvider String?
  notes               String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([clientId])
  @@index([name])
}

model ClientAllergy {
  id       String       @id @default(uuid())
  orgId    String
  org      Organization @relation(fields: [orgId], references: [id])

  clientId String
  client   Client       @relation(fields: [clientId], references: [id])

  allergen String
  reaction String?   // "rash", "anaphylaxis"
  severity String?   // "mild", "moderate", "severe"
  notes    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([clientId])
  @@index([allergen])
}

model ClientInsurance {
  id       String       @id @default(uuid())
  orgId    String
  org      Organization @relation(fields: [orgId], references: [id])

  clientId String
  client   Client       @relation(fields: [clientId], references: [id])

  insuranceType String?  // "Medicare", "Medicaid", "PPO", etc.
  carrier       String?
  policyNumber  String?
  groupNumber   String?
  memberId      String?
  phone         String?
  notes         String?

  primary Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([clientId])
  @@index([carrier])
}

model ClientRisk {
  id       String       @id @default(uuid())
  orgId    String
  org      Organization @relation(fields: [orgId], references: [id])

  clientId String
  client   Client       @relation(fields: [clientId], references: [id])

  category String   // "fall risk", "wandering", "cognition", etc.
  severity String?  // "low", "medium", "high"
  notes    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([clientId])
  @@index([category])
}

model ClientDocument {
  id       String       @id @default(uuid())
  orgId    String
  org      Organization @relation(fields: [orgId], references: [id])

  clientId String
  client   Client       @relation(fields: [clientId], references: [id])

  title    String
  fileUrl  String
  fileType String?     // "pdf", "docx", "jpg", etc.
  category String?     // "Power of Attorney", "Advance Directive", etc.

  uploadedAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([orgId])
  @@index([clientId])
  @@index([category])
}

model CarePlan {
  id       String       @id @default(uuid())
  orgId    String
  org      Organization @relation(fields: [orgId], references: [id])

  clientId String
  client   Client       @relation(fields: [clientId], references: [id])

  title       String
  status      String      // "active", "completed", "archived"
  startDate   DateTime?
  targetDate  DateTime?
  summary     String?

  goals CarePlanGoal[]

  createdById String?
  createdBy   User? @relation("CarePlanCreatedBy", fields: [createdById], references: [id])

  progressNotes ProgressNote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([clientId])
  @@index([status])
}

model CarePlanGoal {
  id         String    @id @default(uuid())
  carePlanId String
  carePlan   CarePlan  @relation(fields: [carePlanId], references: [id], onDelete: Cascade)

  title       String
  description String?
  status      String    // "active", "completed", "deferred"
  priority    String?   // "low", "medium", "high"
  targetDate  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([carePlanId])
}

model ProgressNote {
  id       String       @id @default(uuid())
  orgId    String
  org      Organization @relation(fields: [orgId], references: [id])

  clientId String
  client   Client       @relation(fields: [clientId], references: [id])

  authorId String
  author   User         @relation("UserToProgressNotes", fields: [authorId], references: [id])

  date     DateTime     // the date of the visit / interaction
  noteType String?      // "visit", "phone", "check-in", "carePlanUpdate", etc.
  content  String

  carePlanId String?
  carePlan   CarePlan? @relation(fields: [carePlanId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([clientId])
  @@index([authorId])
  @@index([carePlanId])
}

