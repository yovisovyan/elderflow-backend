datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Organization {
  id           String   @id @default(uuid())
  name         String
  contactEmail String
  billingPlan  String
  billingRulesJson Json?  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users      User[]
  clients    Client[]
  activities Activity[]
  invoices   Invoice[]
  payments   Payment[]
  reports    Report[]
  auditLogs  AuditLog[]
  serviceTypes ServiceType[]

}

model User {
  id        String       @id @default(uuid())
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id])
  role      String // "admin" | "care_manager"
  name      String
  email     String       @unique
  password  String
  lastLogin DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  activities Activity[]
  auditLogs  AuditLog[]
  clients    Client[]   @relation("PrimaryCM")


}

model Client {
  id                  String       @id @default(uuid())
  orgId               String
  org                 Organization @relation(fields: [orgId], references: [id])
  primaryCMId         String
  primaryCM           User         @relation("PrimaryCM", fields: [primaryCMId], references: [id])
  name                String
  dob                 DateTime
  address             String
  billingContactName  String
  billingContactEmail String
  billingContactPhone String
  billingRulesJson    Json
  status              String // active | inactive
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  activities Activity[]
  invoices   Invoice[]



}

model Activity {
  id           String       @id @default(uuid())
  orgId        String
  clientId     String
  cmId         String
  org          Organization @relation(fields: [orgId], references: [id])
  client       Client       @relation(fields: [clientId], references: [id])
  cm           User         @relation(fields: [cmId], references: [id])
  source       String // phone | email | visit | calendar | manual
  startTime    DateTime
  endTime      DateTime
  duration     Int
  billingCode  String?
  isBillable   Boolean
  aiConfidence Float
  notes        String
  isFlagged    Boolean
  capturedByAi Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  serviceTypeId String?
  serviceType   ServiceType? @relation(fields: [serviceTypeId], references: [id])


  invoiceItems InvoiceItem[]
}

model Invoice {
  id          String       @id @default(uuid())
  orgId       String
  clientId    String
  org         Organization @relation(fields: [orgId], references: [id])
  client      Client       @relation(fields: [clientId], references: [id])
  periodStart DateTime
  periodEnd   DateTime
  status      String // draft | sent | paid | overdue
  totalAmount Float
  currency    String
  pdfUrl      String?
  sentAt      DateTime?
  paidAt      DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  items    InvoiceItem[]
 
  payments       Payment[]
}

model InvoiceItem {
  id          String    @id @default(uuid())
  invoiceId   String
  activityId  String?
  invoice     Invoice   @relation(fields: [invoiceId], references: [id])
  activity    Activity? @relation(fields: [activityId], references: [id])
  description String
  quantity    Float
  unitPrice   Float
  amount      Float
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Note {
  id        String   @id @default(uuid())
  orgId     String

  clientId  String
  authorId  String

  content   String
  createdAt DateTime @default(now())
}



model Payment {
  id        String   @id @default(uuid())
  orgId     String
  org       Organization @relation(fields: [orgId], references: [id])
  invoiceId String
  invoice   Invoice  @relation(fields: [invoiceId], references: [id])

  amount    Float
  method    String   // "cash", "check", "bank", "card", "insurance", etc.
  status    String   @default("completed") // future: pending, failed
  paidAt    DateTime @default(now())
  reference String? 

  createdAt DateTime @default(now())
}

model Report {
  id          String   @id @default(uuid())
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id])
  type        String
  periodStart DateTime
  periodEnd   DateTime
  fileUrl     String
  createdAt   DateTime @default(now())
}


model AuditLog {
  id     String       @id @default(uuid())
  orgId  String
  userId String?
  org    Organization @relation(fields: [orgId], references: [id])
  user   User?        @relation(fields: [userId], references: [id])
}

model ServiceType {
  id          String       @id @default(uuid())
  orgId       String
  org         Organization @relation(fields: [orgId], references: [id])
  name        String
  billingCode String?
  rateType    String       // "hourly" | "flat"
  rateAmount  Float
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  activities  Activity[]
}








